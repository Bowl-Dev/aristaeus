// Aristaeus Database Schema
// Automated Bowl Kitchen System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Ingredient Catalog
// ============================================

model Ingredient {
  id               Int      @id @default(autoincrement())
  name             String   @db.VarChar(100)
  category         String   @db.VarChar(50) // 'protein', 'base', 'vegetable', 'topping', 'dressing'

  // Nutritional values per 100g
  caloriesPer100g  Decimal  @map("calories_per_100g") @db.Decimal(6, 2)
  proteinGPer100g  Decimal  @map("protein_g_per_100g") @db.Decimal(5, 2)
  carbsGPer100g    Decimal  @map("carbs_g_per_100g") @db.Decimal(5, 2)
  fatGPer100g      Decimal  @map("fat_g_per_100g") @db.Decimal(5, 2)
  fiberGPer100g    Decimal? @map("fiber_g_per_100g") @db.Decimal(5, 2)

  // Operational
  available        Boolean  @default(true)
  displayOrder     Int?     @map("display_order")

  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  orderItems       OrderItem[]

  //Price
  pricePerG        Decimal  @default(0.0) @map("price_per_g") @db.Decimal(5, 2)

  @@map("ingredients")
}

// ============================================
// User (Customer) Information
// ============================================

model User {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  phone         String   @unique @db.VarChar(20)
  email         String?  @db.VarChar(255)

  // Colombian address (structured)
  streetAddress String   @map("street_address") @db.VarChar(200)
  neighborhood  String   @db.VarChar(100)
  city          String   @db.VarChar(100)
  department    String   @db.VarChar(100)
  postalCode    String?  @map("postal_code") @db.VarChar(6)

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  orders        Order[]

  @@map("users")
}

// ============================================
// Order Header
// ============================================

model Order {
  id              Int       @id @default(autoincrement())

  // User reference
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation(fields: [userId], references: [id])

  // Bowl configuration
  bowlSize        Int       @map("bowl_size") // 250, 320, or 480 grams

  // Status lifecycle
  // pending -> queued -> assigned -> preparing -> ready -> completed
  // Possible: cancelled, failed
  status          String    @default("pending") @db.VarChar(50)

  // Cutlery preference
  includeCutlery  Boolean   @default(false) @map("include_cutlery")

  // Nutritional summary (calculated from order_items)
  totalCalories   Decimal?  @map("total_calories") @db.Decimal(7, 2)
  totalProteinG   Decimal?  @map("total_protein_g") @db.Decimal(6, 2)
  totalCarbsG     Decimal?  @map("total_carbs_g") @db.Decimal(6, 2)
  totalFatG       Decimal?  @map("total_fat_g") @db.Decimal(6, 2)
  totalFiberG     Decimal?  @map("total_fiber_g") @db.Decimal(6, 2)
  totalWeightG    Decimal?  @map("total_weight_g") @db.Decimal(7, 2)

  // Price to charge to the customer
  totalPrice      Decimal?  @map("total_price") @db.Decimal(7, 2)

  // Robot assignment
  assignedRobotId Int?      @map("assigned_robot_id")
  assignedRobot   Robot?    @relation("AssignedOrders", fields: [assignedRobotId], references: [id])

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  assignedAt      DateTime? @map("assigned_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  items           OrderItem[]
  currentRobot    Robot?        @relation("CurrentOrder")

  @@index([status])
  @@index([assignedRobotId])
  @@index([userId])
  @@map("orders")
}

// ============================================
// Order Line Items
// ============================================

model OrderItem {
  id            Int      @id @default(autoincrement())
  orderId       Int      @map("order_id")
  ingredientId  Int      @map("ingredient_id")

  quantityGrams Decimal  @map("quantity_grams") @db.Decimal(7, 2)

  // Assembly sequence (1, 2, 3... for robot execution order)
  sequenceOrder Int      @map("sequence_order")

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  order         Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ingredient    Ingredient @relation(fields: [ingredientId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================
// Robot Registry (Device Abstraction Layer)
// ============================================

model Robot {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(100)
  identifier      String    @unique @db.VarChar(100) // Device ID for authentication

  // Status: 'online', 'offline', 'busy', 'error'
  status          String    @default("offline") @db.VarChar(50)

  // Current order being processed
  currentOrderId  Int?      @unique @map("current_order_id")
  currentOrder    Order?    @relation("CurrentOrder", fields: [currentOrderId], references: [id])

  lastHeartbeat   DateTime? @map("last_heartbeat")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations - orders assigned to this robot
  assignedOrders  Order[]   @relation("AssignedOrders")

  @@index([status])
  @@map("robots")
}
